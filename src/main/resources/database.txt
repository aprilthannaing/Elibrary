CREATE TABLE `category` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `myanmarName` varchar(100) DEFAULT NULL,
 `engName` varchar(100) DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
PRIMARY KEY (`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE `subcategory` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `name` varchar(100) DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
PRIMARY KEY (`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

CREATE TABLE category_subcategory(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
categoryId bigint(20) NOT NULL,
subcategoryId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (categoryId) REFERENCES category (id),
CONSTRAINT FOREIGN KEY (subcategoryId) REFERENCES subcategory (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `author` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `name` varchar(50) DEFAULT NULL,
 `profilePicture` varchar(255) DEFAULT NULL,
 `sort` varchar(50) DEFAULT NULL,
 `authorType` varchar(50) DEFAULT NULL, 
 `entityStatus` varchar(100) DEFAULT NULL,
PRIMARY KEY (`id`))ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
//updated
CREATE TABLE `hluttaw` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `boId` varchar(255) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;

CREATE TABLE `department` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `boId` varchar(255) NOT NULL,
  `hluttawboId` bigint NOT NULL,
  `code` varchar(20) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `FK_s9y70mfjwiqoafj94228` (`hluttawboId`),
  CONSTRAINT `FK_s9y70mfjwiqoafj94228` FOREIGN KEY (`hluttawboId`) REFERENCES `hluttaw` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8;

CREATE TABLE `position` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `boId` varchar(255) NOT NULL,
  `code` varchar(20) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;

CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `boId` varchar(255) NOT NULL,
  `hluttawboId` bigint NOT NULL,
  `departmentboId` bigint NOT NULL,
  `positionboId` bigint NOT NULL,
  `name` varchar(100) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `phoneNo` varchar(100) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `role` varchar(100) DEFAULT NULL,
  `type` varchar(255) DEFAULT NULL,
  `expiredDate` varchar(100) DEFAULT NULL,
  `createdDate` varchar(255) DEFAULT NULL,
  `modifiedDate` varchar(255) DEFAULT NULL,
  `entityStatus` varchar(100) DEFAULT NULL,
  `sessionStatus` varchar(100) DEFAULT NULL,
  `fromUserId` varchar(255) DEFAULT NULL,
  `verificationCode` varchar(6) DEFAULT NULL,//atn
  PRIMARY KEY (`id`),
  KEY `FK_s9ffjsajfkhsj89797` (`hluttawboId`),
  KEY `FK_s9fffjwbesflkjso987` (`departmentboId`),
  KEY `FK_sfjfhwfwshiowse8975430` (`positionboId`),
  CONSTRAINT `FK_s9fffjwbesflkjso987` FOREIGN KEY (`departmentboId`) REFERENCES `department` (`id`),
  CONSTRAINT `FK_s9ffjsajfkhsj89797` FOREIGN KEY (`hluttawboId`) REFERENCES `hluttaw` (`id`),
  CONSTRAINT `FK_sfjfhwfwshiowse8975430` FOREIGN KEY (`positionboId`) REFERENCES `position` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8;

CREATE TABLE `session` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `boId` varchar(255) NOT NULL,
  `userId` bigint NOT NULL,
  `startDate` varchar(50) NOT NULL,
  `endDate` varchar(50) NOT NULL,
  `entityStatus` varchar(100) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `123` (`userId`),
  CONSTRAINT `123` FOREIGN KEY (`userId`) REFERENCES `user` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8;
//updated end

CREATE TABLE `history` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
  userId bigint(20) NOT NULL,
  bookId bigint(20)NOT NULL,
 `actionStatus` varchar(100) DEFAULT NULL,   
 `dateTime`varchar(255) DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (userId) REFERENCES user (id),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE category_subcategory(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
categoryId bigint(20) NOT NULL,
subcategoryId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (categoryId) REFERENCES category (id),
CONSTRAINT FOREIGN KEY (subcategoryId) REFERENCES subcategory (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `publisher` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `name` varchar(255) DEFAULT NULL,
 `sort` varchar(255) DEFAULT NULL, 
 `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;


CREATE TABLE `rating` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `rating` bigint(20) DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;


CREATE TABLE `comment` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL,
 `description` longText DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;


CREATE TABLE `book` (
 `id` bigint(20) NOT NULL AUTO_INCREMENT,
 `boId` varchar(255) NOT NULL, 
 `ISBN` varchar(150) DEFAULT NULL,
 `edition` int(50) DEFAULT NULL,
 `publishedYear` varchar(20) DEFAULT NULL,
 `title` varchar(100) DEFAULT NULL,
 `coverPhoto` varchar(255) DEFAULT NULL,
 `publishedDate` varchar(50) DEFAULT NULL,
 `volume` int(50) DEFAULT NULL,
 `state` varchar(50) DEFAULT NULL,
 `modifiedDate` varchar(50) DEFAULT NULL,
 `createdDate` varchar(50) DEFAULT NULL,
 `sort` varchar(50) DEFAULT NULL,
 `path` varchar(255) DEFAULT NULL,
 `seriesIndex` varchar(50) DEFAULT NULL,
 `size` varchar(50) DEFAULT NULL, 
 `callNo` varchar(50) DEFAULT NULL, 
 `accessionNo` varchar(50) DEFAULT NULL, 
 `downloadApproval` varchar(50) DEFAULT NULL,
 `entityStatus` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE book_author(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
authorId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (authorId) REFERENCES author (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE book_category(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
categoryId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (categoryId) REFERENCES category (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE book_subcategory(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
subcategoryId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (subcategoryId) REFERENCES subcategory (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE book_publisher(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
publisherId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (publisherId) REFERENCES publisher (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE book_comment(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
commentId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (commentId) REFERENCES comment (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE book_rating(
`id` bigint(20) NOT NULL AUTO_INCREMENT,
bookId bigint(20) NOT NULL,
ratingId bigint(20)NOT NULL,
PRIMARY KEY (`id`),
CONSTRAINT FOREIGN KEY (bookId) REFERENCES book (id),
CONSTRAINT FOREIGN KEY (ratingId) REFERENCES rating (id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

alter table book modify column edition varchar(50);
alter table book modify column volume varchar(50);
alter table book add column uploader varchar(50);
alter table category add column priority double;
alter table subcategory add column priority double;
update category set priority=0;
update subcategory set priority=0;
alter table user add column fromUserId varchar(50);
alter table category add column icon varchar(255);
alter table subcategory add column display varchar(255);

alter table book drop column readStatus;
alter table book drop column favouriteStatus;
alter table book drop column bookMarkStatus;
alter table book add column ownRating varchar(255);
alter table book add column averageRating varchar(255);
alter table user add column verificationCode varchar(6);
alter table history add column ratingId varchar(50);

update book set ownRating=0;
update book set averageRating=0;
update book set favouriteStatus="false";
update book set bookMarkStatus="false";

update author set profilePicture="AuthorProfile/author1.png";

ALTER TABLE subcategory CHANGE name myanmarName VARCHAR(255) DEFAULT NULL;
ALTER TABLE subcategory ADD engName VARCHAR(150) DEFAULT NULL;


alter table book drop column searchterms;
ALTER table Book ADD column searchTerms varchar(1000);
UPDATE Book book SET searchTerms = CONCAT_WS ( " ", boId, ISBN, publisher, edition, title, publishedDate, volume, createdDate, callNo, 
accessionNo,(select user.name from User user where user.id = book.uploader));





update subcategory set display="true" where id=7;
update category set icon="CategoryIcon/englishbook.png" where id=4;
update category set icon="CategoryIcon/infonote.png" where id=6;
update category set icon="CategoryIcon/ministrybook.png" where id=2;
update category set icon="CategoryIcon/myanmarbook.png" where id=1;
update category set icon="CategoryIcon/organization.png" where id=3;
update category set icon="CategoryIcon/periodicalbook.png" where id=5;


//Stored procedure
------------------
USE elibrary;
DELIMITER //
DROP PROCEDURE IF EXISTS GET_BookCountByAuthor;
CREATE PROCEDURE GET_BookCountByAuthor()
BEGIN
 SELECT
    BC.categoryId AS 'CAT_ID',
    A.id AS 'AUTHOR_ID',
    A.name AS 'AUTHOR_NAME',
    COUNT(BA.bookId) AS 'TOT_COUNT'
  FROM book_author ba
    INNER JOIN author a
      ON A.id = BA.authorId
    INNER JOIN book_category bc
      ON BA.bookId = BC.bookId
  GROUP BY BC.categoryId,
           A.id,
           A.name,
           A.entityStatus
  ORDER BY TOT_COUNT DESC;
END
//
DELIMITER ;

call GET_BookCountByAuthor()

DELIMITER //
DROP PROCEDURE IF EXISTS GetBookCountByActionStatus;
CREATE PROCEDURE GetBookCountByActionStatus()
BEGIN
 SELECT 
  H.bookId 'BOOK'
,  SUM(CASE WHEN H.actionStatus="READ" THEN 1  -- END) AS 'TOT_COUNT' 
  WHEN H.actionStatus="FAVOURITE" THEN 1  WHEN H.actionStatus="BOOKMARK" THEN 1  END) AS 'TOT_COUNT'
,  H.actionStatus 
  FROM history H
  GROUP BY H.bookId
 ,H.actionStatus
  ORDER BY TOT_COUNT DESC;
END
//DELIMITER ;

call GetBookCountByActionStatus()




DELIMITER //
DROP PROCEDURE IF EXISTS GET_BookId_ByST;
CREATE PROCEDURE GET_BookId_ByST(IN ST nvarchar(1000))
BEGIN
 SELECT b.id
  , b.boId
  FROM book b
  LEFT JOIN book_author ba ON ba.bookId=B.id
  LEFT JOIN book_category bc ON BC.bookId=B.id
  LEFT JOIN book_subcategory bs ON BS.bookId=B.id
  LEFT JOIN book_publisher bp ON bp.bookId=b.id
WHERE CONCAT_WS(' , ', B.publishedDate, B.title, b.ISBN 
  ,b.edition, b.volume,  b.callNo,  b.accessionNo,b.uploader
  , (SELECT a.name FROM author a WHERE a.id=ba.authorId) , (SELECT p.name FROM publisher p  WHERE p.id=bp.publisherId)
  , (SELECT S.myanmarName FROM subcategory s WHERE S.id=BS.subcategoryId),  (SELECT S.engName FROM subcategory s WHERE S.id=BS.subcategoryId),(SELECT C.myanmarName FROM category c WHERE C.id=BC.categoryId)
  ) LIKE CONCAT('%',ST,'%');
END
//DELIMITER ;


DELIMITER //
DROP PROCEDURE IF EXISTS GET_BookId_BySubCat;
CREATE PROCEDURE GET_BookId_BySubCat(IN ST nvarchar(1000), SubcatID varchar(30))
BEGIN
 SELECT b.id
  , b.boId
  FROM book b
  LEFT JOIN book_author ba ON ba.bookId=B.id
  LEFT JOIN book_category bc ON BC.bookId=B.id
  LEFT JOIN book_subcategory bs ON BS.bookId=B.id
  LEFT JOIN book_publisher bp ON bp.bookId=b.id
WHERE CONCAT_WS(' , ', B.publishedDate, B.title, b.ISBN 
  ,b.edition, b.volume,  b.callNo,  b.accessionNo,b.uploader
  , (SELECT a.name FROM author a WHERE a.id=ba.authorId) , (SELECT p.name FROM publisher p  WHERE p.id=bp.publisherId)
  , (SELECT S.myanmarName FROM subcategory s WHERE S.id=BS.subcategoryId), (SELECT S.engName FROM subcategory s WHERE S.id=BS.subcategoryId),(SELECT C.myanmarName FROM category c WHERE C.id=BC.categoryId)
  ) LIKE CONCAT('%',ST,'%')
AND bs.subcategoryId=SubcatID;
END
//DELIMITER ;

call elibrary.GET_BookId_ByCat('နှစ်(၂၀)ပြည့်','2');



USE elibrary;
DELIMITER //
DROP PROCEDURE IF EXISTS GET_BookId_ByCat;
CREATE PROCEDURE GET_BookId_ByCat(IN ST nvarchar(1000), CatID varchar(30))
BEGIN
 SELECT b.id
  , b.boId
  FROM book b
  LEFT JOIN book_author ba ON ba.bookId=B.id
  LEFT JOIN book_category bc ON BC.bookId=B.id
  LEFT JOIN book_subcategory bs ON BS.bookId=B.id
  LEFT JOIN book_publisher bp ON bp.bookId=b.id
WHERE CONCAT_WS(' , ', B.publishedDate, B.title, b.ISBN 
  ,b.edition, b.volume,  b.callNo,  b.accessionNo,b.uploader
  , (SELECT a.name FROM author a WHERE a.id=ba.authorId) , (SELECT p.name FROM publisher p  WHERE p.id=bp.publisherId)
  , (SELECT S.myanmarName FROM subcategory s WHERE S.id=BS.subcategoryId),(SELECT C.myanmarName FROM category c WHERE C.id=BC.categoryId)
  ) LIKE CONCAT('%',ST,'%')
  AND bc.categoryId=CatID;
END
//DELIMITER ;

call GET_BookId_ByCat('နှစ်(၂၀)ပြည့်','2')

DELIMITER //
DROP PROCEDURE IF EXISTS GET_BookId_ByCat;
CREATE PROCEDURE `GET_BookId_ByAuthor`(IN ST NVARCHAR(1000), IN AuID NVARCHAR(30), IN CatID nvarchar(30))
BEGIN
 SELECT b.id
  , b.boId
  FROM book b
  LEFT JOIN book_author ba ON ba.bookId=B.id
  LEFT JOIN book_category bc ON BC.bookId=B.id
  LEFT JOIN book_subcategory bs ON BS.bookId=B.id
  LEFT JOIN book_publisher bp ON bp.bookId=b.id
WHERE CONCAT_WS(' , ', B.publishedDate, B.title, b.ISBN 
  ,b.edition, b.volume,  b.callNo,  b.accessionNo,b.uploader
  , (SELECT a.name FROM author a WHERE a.id=ba.authorId) , (SELECT p.name FROM publisher p  WHERE p.id=bp.publisherId)
  , (SELECT S.myanmarName FROM subcategory s WHERE S.id=BS.subcategoryId), (SELECT S.engName FROM subcategory s WHERE S.id=BS.subcategoryId),(SELECT C.myanmarName FROM category c WHERE C.id=BC.categoryId)
  ) LIKE CONCAT('%',ST,'%')
AND ba.authorId=AuID
AND bc.categoryId=CatID;
END
//DELIMITER ;


CREATE DEFINER=`root`@`localhost` PROCEDURE `GET_BookId_ByAuthor`(IN ST NVARCHAR(1000), IN AuID NVARCHAR(30), IN CatID nvarchar(30))
BEGIN
 SELECT b.id
  , b.boId
  FROM book b
  LEFT JOIN book_author ba ON ba.bookId=B.id
  LEFT JOIN book_category bc ON BC.bookId=B.id
  LEFT JOIN book_subcategory bs ON BS.bookId=B.id
  LEFT JOIN book_publisher bp ON bp.bookId=b.id
WHERE CONCAT_WS(' , ', B.publishedDate, B.title, b.ISBN 
  ,b.edition, b.volume,  b.callNo,  b.accessionNo,b.uploader
  , (SELECT a.name FROM author a WHERE a.id=ba.authorId) , (SELECT p.name FROM publisher p  WHERE p.id=bp.publisherId)
  , (SELECT S.myanmarName FROM subcategory s WHERE S.id=BS.subcategoryId), (SELECT S.engName FROM subcategory s WHERE S.id=BS.subcategoryId),(SELECT C.myanmarName FROM category c WHERE C.id=BC.categoryId)
  ) LIKE CONCAT('%',ST,'%')
AND ba.authorId=AuID
AND bc.categoryId=CatID;
END
call GET_BookId_ByAuthor('a',1,1);

